services:
  ros2-dev:
    image: ${ROS2_IMAGE:-osrf/ros:humble-desktop-full}
    container_name: ${CONTAINER_NAME:-ros2-dev-container}
    hostname: ros2-dev
    
    # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
    network_mode: host
    
    # ê¶Œí•œ ì„¤ì •
    privileged: ${PRIVILEGED:-false}
    
    # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
    environment:
      # ROS2 í™˜ê²½ë³€ìˆ˜
      - ROS_DISTRO=${ROS_DISTRO:-humble}
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_fastrtps_cpp}
      
      # ë””ìŠ¤í”Œë ˆì´ ê´€ë ¨ í™˜ê²½ë³€ìˆ˜ (Linux)
      - DISPLAY=${DISPLAY:-:0}
      - QT_X11_NO_MITSHM=1
      
      # ì‚¬ìš©ì ì •ë³´
      - USER_ID=${USER_ID:-1000}
      - GROUP_ID=${GROUP_ID:-1000}
      - USER_NAME=${USER_NAME:-developer}
      
      # ê°œë°œ í™˜ê²½ ì„¤ì •
      - TERM=xterm-256color
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
    
    # ë³¼ë¥¨ ë§ˆìš´íŠ¸
    volumes:
      # ì‘ì—… ë””ë ‰í† ë¦¬
      - ${WORKSPACE_PATH:-./workspace}:/workspace:rw
      - ${CONFIG_PATH:-./config}:/config:ro
      
      # ë””ìŠ¤í”Œë ˆì´ ê´€ë ¨ ë³¼ë¥¨ (Linux)
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      
      # ë””ë°”ì´ìŠ¤ ì ‘ê·¼ (í•„ìš”í•œ ê²½ìš°)
      - /dev:/dev:rw
      
      # ì‹œê°„ ë™ê¸°í™”
      - /etc/localtime:/etc/localtime:ro
      
      # SSH í‚¤ (ì„ íƒì )
      - ${SSH_KEY_PATH:-~/.ssh}:/home/${USER_NAME:-developer}/.ssh:ro
      
      # Git ì„¤ì • (ì„ íƒì )
      - ${GIT_CONFIG_PATH:-~/.gitconfig}:/home/${USER_NAME:-developer}/.gitconfig:ro
    
    # ì‘ì—… ë””ë ‰í† ë¦¬
    working_dir: /workspace
    
    # ê¸°ë³¸ ëª…ë ¹ì–´ (ì§„ì…ì  ìŠ¤í¬ë¦½íŠ¸ ë˜ëŠ” ì§ì ‘ ì†Œì‹±)
    entrypoint: ["/bin/bash", "-c"]
    command: 
      - |
        echo -e "\033[0;34mğŸ¤– ROS2 ê°œë°œí™˜ê²½ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤...\033[0m"
        
        # Create .bashrc for root user with ROS2 environment
        cat > /root/.bashrc << 'EOF'
        # Source ROS2 environment
        source /opt/ros/humble/setup.bash
        
        # Source workspace if it exists
        if [ -f "/workspace/install/setup.bash" ]; then
            source /workspace/install/setup.bash
        fi
        
        # Useful aliases
        alias cb='colcon build'
        alias cbs='colcon build --symlink-install'
        alias cbp='colcon build --packages-select'
        alias cbt='colcon test'
        alias ctr='colcon test-result'
        alias ll='ls -alF'
        alias la='ls -A'
        alias l='ls -CF'
        
        # ROS2 command completion
        eval "$(register-python-argcomplete3 ros2)" 2>/dev/null || true
        eval "$(register-python-argcomplete3 colcon)" 2>/dev/null || true
        
        # Custom prompt
        export PS1='\[\033[01;32m\][ROS2-$ROS_DISTRO]\[\033[00m\] \[\033[01;34m\]\w\[\033[00m\]\$ '
        
        # Welcome message (only show on interactive shells)
        if [[ $- == *i* ]]; then
            echo -e "\033[0;32mâœ… ROS2 í™˜ê²½ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!\033[0m"
            echo -e "ğŸ“‹ ROS_DISTRO: \033[0;32m$ROS_DISTRO\033[0m"
            echo -e "ğŸŒ ROS_DOMAIN_ID: \033[0;32m$ROS_DOMAIN_ID\033[0m"
            echo -e "ğŸ’» RMW_IMPLEMENTATION: \033[0;32m$RMW_IMPLEMENTATION\033[0m"
        fi
        EOF
        
        echo -e "\033[0;32mğŸ“¦ ROS2 í™˜ê²½ì„ ë¡œë“œí•©ë‹ˆë‹¤...\033[0m"
        source /root/.bashrc
        
        # Keep container running
        tail -f /dev/null
    
    # TTY ì„¤ì •
    tty: true
    stdin_open: true
    
    # ì¬ì‹œì‘ ì •ì±…
    restart: ${RESTART_POLICY:-unless-stopped}
    
    # ë””ë°”ì´ìŠ¤ ì ‘ê·¼ (GPU ë“±)
    devices:
      - /dev/dri:/dev/dri  # GPU ì ‘ê·¼
    
    # í¬íŠ¸ ë§¤í•‘ (í•„ìš”í•œ ê²½ìš°)
    ports:
      - "${ROS2_MASTER_PORT:-11311}:11311"
      - "${RVIZ_PORT:-8080}:8080"
    
    # ë³´ì•ˆ ì„¤ì •
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    
    # ë©”ëª¨ë¦¬ ë° CPU ì œí•œ (ì„ íƒì )
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-8G}
          cpus: '${CPU_LIMIT:-4.0}'
        reservations:
          memory: ${MEMORY_RESERVATION:-2G}
          cpus: '${CPU_RESERVATION:-1.0}'

  # ì¶”ê°€ ì„œë¹„ìŠ¤ ì˜ˆì‹œ (Gazebo ì‹œë®¬ë ˆì´ì…˜)
  gazebo:
    image: ${GAZEBO_IMAGE:-osrf/ros:humble-desktop-full}
    container_name: ${GAZEBO_CONTAINER_NAME:-gazebo-container}
    depends_on:
      - ros2-dev
    
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=${XAUTH:-/tmp/.docker.xauth}
      - GAZEBO_MASTER_URI=http://ros2-dev:11345
    
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTH:-/tmp/.docker.xauth}:/tmp/.docker.xauth:rw
      - ${WORKSPACE_PATH:-./workspace}:/workspace:rw
      - ${GAZEBO_MODELS_PATH:-./gazebo_models}:/home/developer/.gazebo/models:rw
    
    network_mode: host
    privileged: ${PRIVILEGED:-false}
    
    command: ${GAZEBO_COMMAND:-gzserver}
    
    profiles:
      - simulation

# ë„¤íŠ¸ì›Œí¬ ì„¤ì • (host ëª¨ë“œê°€ ì•„ë‹Œ ê²½ìš°)
networks:
  ros2_network:
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-172.20.0.0/16}

# ë³¼ë¥¨ ì„¤ì •
volumes:
  ros2_workspace:
    driver: local
  ros2_config:
    driver: local